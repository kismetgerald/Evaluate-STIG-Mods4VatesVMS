#!/usr/bin/env python3
"""
Integrate comprehensive comment content into answer file entries.

Creates two Answer Indices per function with meaningful ValidTrueComment content:
- Index 1: ExpectedStatus="NotAFinding" (compliant state)
- Index 2: ExpectedStatus="Open" (non-compliant state + remediation)

Usage:
    python integrate_answer_file_comments.py
"""

import os
import re
from datetime import datetime
import shutil

SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
PROJECT_ROOT = os.path.abspath(os.path.join(SCRIPT_DIR, '..', '..'))
ANSWER_FILE_PATH = os.path.join(PROJECT_ROOT, 'AnswerFiles', 'XO_v5.x_WebSRG_AnswerFile.xml')

# Comment content for all 10 functions (from Agent a1d84ca analysis)
COMMENTS = {
    'V-206425': {
        'NotAFinding': '''The automated check verified that Xen Orchestra web server generates log records using UTC or GMT timestamps, satisfying DoD requirements for forensic analysis and cross-system correlation. The check examined five key areas: (1) Winston logger timezone configuration in config.toml files, confirming UTC settings; (2) System timezone via timedatectl, verifying UTC/GMT/Etc/UTC configuration; (3) Node.js TZ environment variables in running processes; (4) Sample log timestamps showing ISO 8601 format with Z suffix or +00:00 offset; and (5) /etc/timezone file contents. All timestamps detected use UTC/GMT format, enabling accurate forensic correlation across distributed systems without timezone conversion. This configuration meets SRG-APP-000374-WSR-000172 requirements for establishing event time in forensic analysis. The system has been configured correctly to support incident response and security event correlation.''',
        'Open': '''The automated check detected local time zone configuration instead of UTC/GMT timestamps, failing to meet DoD requirements for forensic analysis. Evidence examined includes: (1) Winston logger configuration showing local timezone settings (e.g., America/New_York, US/Eastern); (2) System timezone via timedatectl reporting non-UTC zones; (3) Log samples showing timezone offsets other than +00:00 (e.g., -05:00 for EST); and (4) /etc/timezone containing regional timezone identifiers. This configuration impairs forensic correlation as timestamps require manual timezone conversion when comparing events across systems. REMEDIATION: Execute 'timedatectl set-timezone UTC' to configure system for UTC timestamps. Restart XO server with 'systemctl restart xo-server'. Verify log timestamps show ISO 8601 format with Z suffix (e.g., 2026-02-03T12:00:00.000Z) not local offsets (e.g., 2026-02-03T07:00:00-05:00). Confirm changes persist across reboots by reviewing systemd journal output. Update organizational time synchronization policy to mandate UTC for all security-relevant systems.'''
    },
    'V-206426': {
        'NotAFinding': '''The automated check performed 5 verification methods to confirm timestamp granularity compliance. CHECK 1 examined Winston logger configuration for explicit timestamp format settings, detecting ISO 8601 with milliseconds as the default. CHECK 2 analyzed sample log timestamps from /var/log/xo-server/xo-server.log and /var/log/syslog, successfully identifying millisecond-precision timestamps matching the pattern YYYY-MM-DDTHH:MM:SS.sssZ. CHECK 3 reviewed systemd journal timestamps using the short-precise output format, confirming microsecond-level precision. CHECK 4 verified Node.js Date.now() methodology, which returns milliseconds since Unix epoch by design. CHECK 5 queried the XO audit plugin via REST API to examine audit record timestamps stored as Unix millisecond values. The system demonstrates timestamp granularity of 1/1000 second (milliseconds), which exceeds the DoD requirement of â‰¥1 second minimum granularity. This level of precision enables accurate incident correlation, security event analysis, and audit trail reconstruction required for DoD compliance.''',
        'Open': '''The automated check detected insufficient timestamp granularity that does not meet DoD requirements. The verification process examined Winston logger configuration, sample log file timestamps, systemd journal precision, Node.js timestamp methodology, and XO audit plugin records. FAILURE CRITERIA: Either minute-level timestamps were detected (YYYY-MM-DDTHH:MMZ format without seconds), or timestamp precision could not be determined from available logs. DoD Requirement NOT MET: Timestamps must record events to a minimum granularity of one second for forensic analysis, audit trail integrity, and security event correlation. REMEDIATION STEPS: (1) Review Winston logger configuration in /opt/xo/xo-server/config.toml or /etc/xo-server/config.toml; (2) Ensure timestamp format includes seconds - Acceptable formats include ISO 8601 with seconds (YYYY-MM-DDTHH:MM:SSZ) or milliseconds (YYYY-MM-DDTHH:MM:SS.sssZ); (3) Verify log output format with journalctl -u xo-server --since '1 minute ago' | head -5; (4) If using custom logging middleware, verify format string includes seconds (%S or :ss); (5) Restart XO server service with systemctl restart xo-server; (6) Test timestamp precision by monitoring tail -f /var/log/xo-server/xo-server.log and verify timestamp format; (7) For systemd journal persistence, ensure Storage=persistent in /etc/systemd/journald.conf; (8) Document timestamp configuration in system security configuration baseline.'''
    },
    'V-206433': {
        'NotAFinding': '''The automated check performed technical discovery across 4 verification methods to assess server tuning configuration. CHECK 1 examined Node.js memory/heap limits via NODE_OPTIONS environment variable, detecting explicit --max-old-space-size or --max-heap-size settings. CHECK 2 analyzed process-level resource limits by reading /proc/[XO_PID]/limits for the XO server process, confirming configured file descriptor, memory, and CPU quota restrictions. CHECK 3 reviewed XO configuration tuning parameters in config.toml for settings like maxMemory, heapSize, maxConnections, connectionTimeout, and requestTimeout. CHECK 4 verified systemd service resource limits using systemctl show xo-server for MemoryLimit, CPUQuota, and TasksMax directives. Technical tuning parameters were detected, indicating deliberate capacity planning for expected traffic loads. However, DoD compliance requires organizational documentation correlating these technical settings with traffic analysis, risk assessment, and ISSO/ISSM approval. The system demonstrates configured tuning parameters, but manual ISSO/ISSM review is required to verify alignment with organizational capacity planning and DoD prevention strategies.''',
        'Open': '''The automated check completed technical discovery but detected either no explicit tuning parameters OR insufficient organizational policy documentation. HYBRID CHECK RATIONALE: Technical detection cannot determine DoD compliance - even with tuning parameters present, compliance requires documented correlation between server tuning and expected user traffic loads, supported by risk analysis and ISSO/ISSM approval. REQUIRED ORGANIZATIONAL DOCUMENTATION: (1) Traffic Analysis &amp; Capacity Planning documenting expected concurrent users, request rates, peak traffic patterns, and historical load data; (2) Risk Assessment for DoS Scenarios analyzing denial-of-service attack vectors, resource exhaustion risks, and mitigation strategies; (3) Tuning Parameter Justification documenting rationale for Node.js heap limits, connection pools, timeout values, and systemd resource restrictions; (4) Load Testing Results providing evidence of performance testing validating tuning effectiveness under stress conditions; (5) Change Management Records showing Configuration Control Board (CCB) approval for tuning modifications; (6) Periodic Review Documentation verifying tuning parameters are reassessed when traffic patterns change. REMEDIATION STEPS (Technical): Configure Node.js memory limits with NODE_OPTIONS="--max-old-space-size=4096" (4GB heap); Set systemd resource limits in /etc/systemd/system/xo-server.service.d/override.conf with MemoryLimit=8G, CPUQuota=400%, TasksMax=4096; Configure XO connection limits in config.toml with maxConnections=1000, requestTimeout=30000; Apply ulimit settings in /etc/security/limits.conf for xo-server user; Reload systemd and restart service with systemctl daemon-reload &amp;&amp; systemctl restart xo-server; Document all settings in organizational tuning policy with traffic analysis justification.'''
    },
    'V-206445': {
        'NotAFinding': '''The automated check performed comprehensive configuration discovery across 6 verification methods to assess DoD baseline compliance. CHECK 1 searched for active configuration management systems (Ansible, Puppet, Chef, SaltStack) using systemctl is-active queries. CHECK 2 enumerated XO configuration files at /opt/xo/xo-server/config.toml and /etc/xo-server/config.toml with file permissions analysis. CHECK 3 examined security hardening evidence in /etc/security/limits.conf, /etc/sysctl.conf, /etc/ssh/sshd_config, and /etc/pam.d/common-auth to detect system-level security controls. CHECK 4 searched common documentation repositories (/root/stig, /etc/stig, /usr/share/doc/stig, /opt/stig, /var/log/stig) for baseline documentation files (*.pdf, *.txt, *.md). CHECK 5 detected compliance automation tools (oscap, lynis, tiger, openscap-scanner) installed on the system. CHECK 6 searched /var/log for compliance scan logs (*stig*, *compliance*, *oscap*). Configuration management indicators and security hardening evidence were detected. However, DoD compliance requires manual ISSO/ISSM review of approved security configuration baseline documentation, STIG compliance scan results, NSA configuration guide compliance matrices, applicable CTO compliance records, and Configuration Control Board (CCB) approval documentation. The system shows security configuration elements, but organizational baseline documentation review is mandatory for ATO compliance determination.''',
        'Open': '''The automated check completed configuration discovery and detected either no configuration management systems, no baseline documentation, or no compliance scanning tools. ORGANIZATIONAL POLICY CHECK: Automated verification cannot determine DoD baseline compliance - this requires manual ISSO/ISSM review of approved security configuration baseline documents. DoD requirement mandates adherence to Web Server SRG V4R4, NSA configuration guides, Cyber Tasking Orders (CTOs), and DoD Technical Memoranda (DTMs). MANDATORY MANUAL VERIFICATION requires: (1) DOD STIG COMPLIANCE verification that XO configuration matches Web Server SRG V4R4 requirements with all applicable STIG controls implemented or documented as N/A, deviation requests for non-compliant settings reviewed, and STIG compliance scan results (OpenSCAP, Nessus, SCAP) validated; (2) NSA CONFIGURATION GUIDES verification of adherence to NSA Cybersecurity Technical Reports (CTRs), review of NSA hardening guidance for Debian 12 and Node.js applications, confirmation of secure defaults per NSA recommendations; (3) CYBER TASKING ORDERS (CTOs) identification of applicable CTOs from USCYBERCOM/JFHQ-DODIN, verification of compliance with time-sensitive security directives, documentation of CTO implementation or waiver status; (4) DoD TECHNICAL MEMORANDA (DTMs) review of applicable DTMs for web servers and virtualization management, verification of compliance with DTM requirements, documentation of organizational interpretation; (5) ORGANIZATIONAL SECURITY BASELINE confirmation that configuration matches organization's approved security baseline, review of CCB approval records, verification of change management documentation, validation of periodic baseline compliance reviews. REQUIRED EVIDENCE includes approved security configuration baseline document, STIG compliance scan results, NSA configuration guide compliance matrix, applicable CTO compliance documentation, CCB approval records, deviation requests and waiver approvals, periodic compliance review reports, and configuration management system reports. NON-COMPLIANCE RISK: Failure to configure per DoD security baselines increases attack surface, may result in unauthorized access or data compromise, and may prevent system accreditation resulting in ATO denial.'''
    },
    'V-264341': {
        'NotAFinding': '''The automated check performed comprehensive enforcement logging verification across 5 verification methods. CHECK 1 detected XO audit plugin packages in /opt/xo/packages and /usr/share/xo-server directories, confirming audit plugin installation. CHECK 2 examined Winston logger configuration in config.toml for enforcement event logging levels (info, verbose, debug), verifying explicit log level settings or confirming Winston defaults. CHECK 3 analyzed sample enforcement events in /var/log/xo-server/xo-server.log and /var/log/syslog using grep patterns for enforcement keywords (denied, blocked, enforced, rejected, forbidden, violation, 401, 403 HTTP codes). CHECK 4 queried systemd journal for XO server enforcement records over the past 7 days using journalctl filtering. CHECK 5 retrieved XO audit records via REST API (/rest/v0/plugins/audit/records) to verify enforcement action logging at the application level. COMPLIANCE CONFIRMED: Enforcement actions are automatically logged including VM operation denials (RBAC/ACL blocks), authentication failures and lockouts, configuration change rejections, resource quota enforcement, and policy violation blocks. The system demonstrates multi-layer audit logging infrastructure meeting DoD requirements for automatic enforcement action audit trail generation.''',
        'Open': '''The automated check could not confirm automatic enforcement audit logging capability. VERIFICATION INCONCLUSIVE: CHECK 1 did not detect XO audit plugin packages (disabled or not installed); CHECK 3 and CHECK 4 found no enforcement events in logs over the past 7 days (may indicate no violations occurred or logging disabled); CHECK 5 could not access REST API audit records (no API token or audit plugin disabled). DoD Requirement NOT MET: Enforcement actions MUST be automatically logged for audit trail and security monitoring purposes. REMEDIATION STEPS: (1) Enable XO audit plugin with xo-cli plugin.enable id=xo-server-audit &amp;&amp; systemctl restart xo-server; (2) Configure Winston logger for enforcement events in /opt/xo/xo-server/config.toml or /etc/xo-server/config.toml with log level = "info" or "verbose" for detailed enforcement logging; (3) Test enforcement logging by attempting unauthorized VM operation (e.g., start VM without permission) and reviewing logs with tail -f /var/log/xo-server/xo-server.log; (4) Verify enforcement event recorded with action type and outcome (HTTP 401/403, ACL denial details, user identity, timestamp); (5) Query audit records via REST API with GET /rest/v0/plugins/audit/records?limit=10 to verify enforcement actions present; (6) Create API token for STIG compliance checks by creating /etc/xo-server/stig/api-token with chmod 600 and chown root:root permissions; (7) Configure log rotation to prevent audit log exhaustion by editing /etc/logrotate.d/xo-server; (8) Forward audit logs to centralized SIEM by configuring rsyslog or syslog-ng for remote audit server delivery; (9) Document enforcement action logging in system security configuration baseline.'''
    },
    'V-264343': {
        'NotAFinding': '''The automated check performed MFA capability detection across 6 verification methods. CHECK 1 searched for XO authentication plugins (xo-server-auth-*) in /opt/xo and /etc/xo-server directories, detecting LDAP, SAML, OIDC, or OAuth external authentication providers that support MFA passthrough. CHECK 2 examined LDAP/Active Directory integration settings in config.toml to verify external directory service authentication delegation (LDAP servers often enforce MFA at directory level). CHECK 3 detected SAML/OAuth/OIDC configuration in config files, indicating federated authentication provider integration capable of MFA enforcement. CHECK 4 searched for installed Two-Factor Authentication (2FA) npm packages (2fa, totp, speakeasy, authenticator) using npm list queries. CHECK 5 analyzed PAM configuration in /etc/pam.d/ for MFA modules (pam_google_authenticator, pam_oath, pam_duo) enforcing system-level MFA for SSH/console access. CHECK 6 examined reverse proxy MFA enforcement (nginx auth_request, oauth2_proxy) in /etc/nginx configuration. MFA-capable authentication infrastructure was detected. However, DoD compliance requires manual ISSO/ISSM verification of MFA enforcement for ALL users, user enrollment status, authentication strength compliance with NIST SP 800-63B, and organizational MFA policy adherence. The system shows MFA capability, but organizational MFA enrollment and policy enforcement verification is mandatory.''',
        'Open': '''The automated check detected no MFA indicators OR cannot verify MFA enforcement without manual review. AUTOMATED DETECTION LIMITATIONS: No authentication plugins detected; no external authentication provider configuration; default XO authentication likely in use (local accounts only); no 2FA npm packages or PAM MFA modules found. DoD Requirement NOT MET: MFA must be implemented for local, network, and remote access to privileged AND nonprivileged accounts per organizational requirements. MANDATORY MANUAL VERIFICATION requires: (1) MFA IMPLEMENTATION verification that MFA is enabled for ALL privileged accounts (administrators) and for nonprivileged accounts per org policy, MFA enforcement for local, network, AND remote access confirmed, and MFA login process tested with representative user accounts; (2) AUTHENTICATION STRENGTH REQUIREMENTS verification that MFA mechanism meets organization-defined strength requirements with acceptable factors including CAC/PIV, OTP (TOTP/HOTP), hardware tokens, or biometrics, unacceptable single factors including SMS, email, or knowledge-based authentication, and compliance with NIST SP 800-63B Authenticator Assurance Levels confirmed; (3) MFA ENROLLMENT AND MANAGEMENT verification that all users are enrolled in MFA program, MFA enrollment procedures and documentation reviewed, backup authentication methods are secure, and MFA recovery/reset procedures prevent unauthorized access; (4) ORGANIZATIONAL POLICY COMPLIANCE review of organization's MFA policy document, verification that web server MFA aligns with org requirements, documentation of any approved exceptions or waivers, and confirmation that periodic MFA compliance audits are conducted. IMPLEMENTATION GUIDANCE: LDAP/Active Directory Integration by installing xo-server-auth-ldap plugin and configuring LDAP server with MFA support (AD + Azure MFA, FreeIPA + OTP) where XO delegates authentication to LDAP with MFA enforced at directory level; SAML/OAuth Integration by installing xo-server-auth-saml or xo-server-auth-oidc and configuring identity provider with MFA (Azure AD, Okta, Keycloak) where users authenticate via IdP with MFA and XO receives assertion; Reverse Proxy MFA by deploying nginx with oauth2_proxy, configuring OAuth provider with MFA requirement, and proxying all XO access through MFA gateway; System-Level PAM MFA by installing libpam-google-authenticator, configuring /etc/pam.d/sshd for TOTP, and enforcing MFA for SSH access (Xen Orchestra console access).'''
    },
    'V-264344': {
        'NotAFinding': '''The automated check completed MFA strength verification using organizational policy documentation discovery methods. The system demonstrates MFA implementation via external authentication providers (LDAP/AD, SAML, OAuth) or authentication plugins that support DoD-compliant MFA factors. Manual ISSO/ISSM review confirms MFA mechanisms meet organization-defined strength requirements including use of separate device factors. ACCEPTABLE MFA FACTORS (DoD-Compliant): CAC/PIV smartcards (FIPS 201 compliant, separate physical device); hardware security tokens (FIPS 140-2 validated, separate cryptographic device); mobile authenticator apps (TOTP/HOTP on separate smartphone/tablet device); biometric authentication paired with separate device possession factor (fingerprint + CAC). SEPARATE DEVICE REQUIREMENT MET: At least one factor is provided by a device separate from the system gaining access. Multi-factor authentication strength complies with NIST SP 800-63B Authenticator Assurance Level 2 (AAL2) or higher requirements. Organizational MFA policy documentation reviewed and approved by ISSO/ISSM. User enrollment in DoD-compliant MFA program verified at 100% for privileged accounts and per org policy for nonprivileged accounts.''',
        'Open': '''The automated check detected MFA capability but cannot verify authentication strength requirements without manual review. ORGANIZATIONAL POLICY CHECK: DoD compliance requires verification that MFA mechanisms use factors from separate devices and meet organization-defined strength requirements. AUTOMATED DETECTION LIMITATIONS: Cannot verify MFA factor types (CAC vs SMS); cannot determine if separate device requirement met; cannot validate FIPS 140-2 compliance; cannot confirm user enrollment status. MANDATORY MANUAL VERIFICATION requires: (1) ACCEPTABLE MFA FACTORS (DoD-Compliant) including CAC/PIV smartcards (FIPS 201 compliant - separate physical device), hardware security tokens (RSA SecurID, YubiKey - FIPS 140-2 validated), mobile authenticator apps (Google Authenticator, Microsoft Authenticator - TOTP/HOTP on separate device), and biometric + possession factor (fingerprint scan + CAC/smartphone); (2) UNACCEPTABLE MFA FACTORS (Non-Compliant) including SMS text messages to phone (vulnerable to SIM swapping attacks), email verification codes (email compromise risk), knowledge-based authentication only (security questions - not separate device), and push notifications without separate possession factor (notification approve/deny on same device); (3) SEPARATE DEVICE REQUIREMENT verification that at least one authentication factor is provided by a device physically separate from the system being accessed with examples including CAC reader, smartphone, hardware token, or biometric scanner paired with smartcard; (4) NIST SP 800-63B COMPLIANCE verification that MFA implementation meets Authenticator Assurance Level 2 (AAL2) minimum requirements, confirmation of multi-factor cryptographic authentication using approved algorithms, and validation of verifier impersonation resistance; (5) ORGANIZATIONAL MFA STRENGTH POLICY review of organization-defined MFA strength requirements, verification that web server MFA aligns with org policy, documentation of approved MFA factor types, and confirmation of periodic strength reassessment. IMPLEMENTATION GUIDANCE: CAC/PIV Integration (Strongest) by configuring XO authentication plugin for DoD CAC/PIV certificate-based authentication where users must insert CAC into reader AND enter PIN (two factors - possession + knowledge) with FIPS 201 compliant smartcards using separate cryptographic device; Hardware Token Integration by deploying FIPS 140-2 validated hardware tokens (YubiKey, RSA SecurID) and configuring LDAP/SAML provider to require token code where users authenticate with password + token code (knowledge + possession of separate device); Mobile Authenticator Apps (TOTP/HOTP) by configuring authentication provider for time-based one-time passwords where users install Google Authenticator or Microsoft Authenticator on smartphone and enter password + TOTP code from separate mobile device; Prohibit Weak Factors by disabling SMS-based MFA (SIM swapping vulnerability), disabling email-based codes (email compromise risk), disabling knowledge-based questions (not separate device), and documenting prohibited factors in organizational policy.'''
    },
    'V-264356': {
        'NotAFinding': '''The automated check performed comprehensive DoD PKI trust anchor verification across 5 verification methods. CHECK 1 examined system CA certificate stores (/etc/ssl/certs, /usr/share/ca-certificates, /etc/pki/ca-trust/source/anchors) using directory listing and grep patterns for DoD-related certificate files. CHECK 2 performed deep inspection of certificate stores using find + grep to search for DoD Root CA certificates by content, specifically detecting DoD Root CA 3, DoD Root CA 4, DoD Root CA 5, and DoD Root CA 6. CHECK 3 analyzed XO Node.js trust store configuration via NODE_EXTRA_CA_CERTS environment variable and systemd service file Environment directives, verifying custom CA bundle inclusion of DoD CAs. CHECK 4 validated certificate chain trust by examining XO's TLS certificate with openssl verify and openssl x509 issuer analysis, confirming DoD PKI issuance. CHECK 5 checked for expired or invalid CA certificates in system stores using openssl x509 -checkend. COMPLIANCE CONFIRMED: DoD Root CA certificates detected in system trust stores; XO Node.js application configured to use system CA store or custom bundle including DoD CAs; certificate chain validation successful with DoD PKI issuer; no expired DoD CA certificates found. The system demonstrates proper DoD PKI trust anchor configuration meeting DoD requirements for TLS/SSL certificate validation.''',
        'Open': '''The automated check could not confirm DoD trust anchor configuration. VERIFICATION INCONCLUSIVE OR NON-COMPLIANT: CHECK 1 and CHECK 2 did not detect DoD Root CA certificates in system trust stores (/etc/ssl/certs, /usr/share/ca-certificates, /etc/pki/ca-trust/source/anchors); system is using default/commercial CA trust anchors only (e.g., DigiCert, Let's Encrypt, VeriSign); CHECK 3 found NODE_EXTRA_CA_CERTS not configured or custom CA bundle missing DoD CAs; CHECK 4 certificate chain validation shows non-DoD issuer. DoD Requirement NOT MET: Web server must use DoD PKI-established certificate authorities for TLS/SSL certificate validation. MANDATORY MANUAL VERIFICATION and REMEDIATION: (1) DOD ROOT CA CERTIFICATE INSTALLATION by verifying presence of DoD Root CA 3, 4, 5, and 6 in system trust stores, downloading DoD PKI CA certificates from https://public.cyber.mil/pki-pke/pkipke-document-library/, installing to /usr/local/share/ca-certificates/ and running update-ca-certificates, and verifying systemwide trust via ls -la /etc/ssl/certs | grep -i dod; (2) NODE.JS TRUST STORE CONFIGURATION by exporting NODE_EXTRA_CA_CERTS=/etc/ssl/certs/ca-certificates.crt in XO systemd service file or creating custom CA bundle combining DoD CAs + system CAs, and verifying Node.js recognizes DoD trust anchors with openssl s_client -connect localhost:443 -CAfile /etc/ssl/certs/ca-certificates.crt; (3) XO TLS CERTIFICATE VERIFICATION by obtaining XO TLS certificate from DoD PKI (not commercial CA), verifying certificate chain with openssl verify -CAfile /etc/ssl/certs/ca-certificates.crt /path/to/xo-cert.pem, and confirming issuer shows DoD Root CA with openssl x509 -in /path/to/xo-cert.pem -noout -issuer; (4) CERTIFICATE EXPIRATION MONITORING by checking DoD CA certificate expiration dates with openssl x509 -in /etc/ssl/certs/DoD_Root_CA_6.pem -noout -dates, implementing automated monitoring for expiring DoD CAs (30/60/90 day warnings), and documenting DoD CA renewal procedures in organizational PKI policy; (5) ORGANIZATIONAL PKI POLICY COMPLIANCE by reviewing organization's PKI policy document, verifying DoD trust anchor configuration aligns with org requirements, confirming DoD PKI registration and certificate issuance procedures, and validating periodic PKI compliance audits conducted. Detailed installation steps: Download DoD CA certificates from public.cyber.mil; Install with sudo cp DoD_Root_CA_*.crt /usr/local/share/ca-certificates/ &amp;&amp; sudo update-ca-certificates; Configure XO systemd service in /etc/systemd/system/xo-server.service.d/override.conf with Environment="NODE_EXTRA_CA_CERTS=/etc/ssl/certs/ca-certificates.crt"; Reload systemd and restart with systemctl daemon-reload &amp;&amp; systemctl restart xo-server; Verify certificate chain with openssl verify and test TLS connection with openssl s_client -connect localhost:443.'''
    },
    'V-264358': {
        'NotAFinding': '''The automated check performed comprehensive time synchronization verification across 6 verification methods. CHECK 1 verified NTP service status using systemctl is-active ntp/ntpd, detecting active NTP daemon. CHECK 2 verified chrony service status using systemctl is-active chronyd, detecting active chrony time synchronization. CHECK 3 examined systemd-timesyncd status using timedatectl show-timesync, confirming configured NTP servers and poll intervals. CHECK 4 analyzed time synchronization configuration files (/etc/ntp.conf, /etc/chrony/chrony.conf, /etc/systemd/timesyncd.conf) for server/pool directives specifying authoritative time sources. CHECK 5 confirmed system clock synchronization status via timedatectl status showing "System clock synchronized: yes". CHECK 6 verified NTP server reachability using ntpq -p (for NTP) or chronyc sources (for chrony), detecting active peer connections with synchronization indicators (*,+,o markers). COMPLIANCE CONFIRMED: System clock is actively synchronized with authoritative time source; time synchronization service running (NTP/chrony/systemd-timesyncd); NTP servers reachable and responding; time drift within acceptable tolerance; synchronization status verified via timedatectl. The system demonstrates proper time synchronization infrastructure meeting DoD requirements for accurate and consistent timekeeping across the enterprise.''',
        'Open': '''The automated check detected time synchronization failure or could not confirm synchronization. VERIFICATION FAILED: CHECK 1-3 found no active time synchronization services (NTP, chrony, systemd-timesyncd all inactive); CHECK 4 found no time synchronization configuration files or no server directives; CHECK 5 detected "System clock synchronized: no" via timedatectl status; CHECK 6 unable to verify NTP server reachability (no peers, unreachable servers, or stale synchronization). DoD Requirement NOT MET: Web server system clock must be synchronized with authoritative time source. REMEDIATION STEPS: (1) Install and enable time synchronization service (Debian 12 default: systemd-timesyncd) with sudo systemctl enable systemd-timesyncd &amp;&amp; sudo systemctl start systemd-timesyncd; (2) Configure authoritative time sources in /etc/systemd/timesyncd.conf with NTP=time.nist.gov time-a.nist.gov time-b.nist.gov and FallbackNTP=0.debian.pool.ntp.org 1.debian.pool.ntp.org; (3) Alternative chrony installation with sudo apt install chrony and configuration in /etc/chrony/chrony.conf with server time.nist.gov iburst, server tick.usno.navy.mil iburst, server tock.usno.navy.mil iburst; (4) Alternative NTP daemon installation with sudo apt install ntp and configuration in /etc/ntp.conf with server time.nist.gov iburst, server tick.usno.navy.mil iburst; (5) Verify time synchronization status with timedatectl status showing "System clock synchronized: yes" and timedatectl show-timesync --all; (6) For chrony verify with chronyc sources looking for * or + markers; for NTP verify with ntpq -p looking for * in first column; (7) Configure firewall to allow NTP traffic (UDP port 123) with sudo ufw allow 123/udp; (8) Test time synchronization with sudo timedatectl set-ntp true &amp;&amp; sleep 5 &amp;&amp; timedatectl status; (9) Document time synchronization configuration in system security configuration baseline; (10) Implement monitoring with cron job to alert on time sync failures running */15 * * * * timedatectl status | grep -q "synchronized: yes" || echo "Time sync failure" | mail -s "ALERT: Time Sync Failure" admin@example.com.'''
    },
    'V-264359': {
        'NotAFinding': '''The automated check performed time synchronization frequency verification across 6 verification methods. CHECK 1 examined NTP poll interval configuration in /etc/ntp.conf for minpoll and maxpoll directives (typical: minpoll 6 = 64 seconds, maxpoll 10 = 1024 seconds = 17 minutes). CHECK 2 analyzed chrony poll interval configuration in /etc/chrony/chrony.conf for polltarget, minpoll, and maxpoll settings. CHECK 3 verified systemd-timesyncd poll interval configuration in /etc/systemd/timesyncd.conf for PollIntervalMinSec and PollIntervalMaxSec (defaults: 32 seconds minimum, 2048 seconds = 34.1 minutes maximum). CHECK 4 searched for automated time drift monitoring via cron jobs executing ntpq, chronyc, or timedatectl commands. CHECK 5 searched for organizational time synchronization policy documentation in standard locations. CHECK 6 verified current synchronization frequency using ntpq -p (NTP), chronyc tracking (chrony), or timedatectl show-timesync (systemd-timesyncd). COMPLIANCE CONFIRMED: Time synchronization configured with organization-defined comparison frequency; poll intervals within acceptable ranges for maintaining time accuracy; automated monitoring detected or service-level monitoring active; organizational policy documentation reviewed and approved. The system demonstrates proper clock comparison frequency meeting DoD requirements for continuous time synchronization with authoritative sources.''',
        'Open': '''The automated check detected time synchronization configuration but cannot verify organizational policy compliance for comparison frequency. ORGANIZATIONAL POLICY VERIFICATION REQUIRED: Automated detection found poll interval configuration (if present) but DoD compliance requires documented correlation between synchronization frequency and organizational timekeeping accuracy requirements. CHECK 1-3 detected poll intervals OR confirmed service defaults, but cannot determine if frequency meets organization-defined requirements; CHECK 4 found no automated time drift monitoring cron jobs; CHECK 5 found no time synchronization policy documentation in standard locations. MANDATORY MANUAL VERIFICATION requires: (1) ORGANIZATIONAL CLOCK COMPARISON FREQUENCY POLICY review of organization's time synchronization policy document specifying required clock comparison frequency with typical DoD requirements including continuous synchronization (NTP poll intervals), periodic comparison at organization-defined intervals (hourly, daily, etc.), time drift tolerance thresholds (milliseconds/seconds), and escalation procedures for synchronization failures; (2) SYNCHRONIZATION FREQUENCY ADEQUACY verification that configured poll intervals meet organizational requirements, evaluation of whether minpoll/maxpoll settings maintain acceptable time accuracy, confirmation that comparison frequency is sufficient for audit log correlation, and validation that synchronization frequency supports forensic analysis needs; (3) TIME DRIFT MONITORING AND ALERTING verification of automated monitoring alerts on synchronization failures, confirmation of time drift tolerance thresholds configured, validation of escalation procedures for out-of-sync conditions, and testing of monitoring system with simulated time sync failure; (4) PERIODIC COMPLIANCE VERIFICATION review of time synchronization compliance audit reports, verification of periodic checks of NTP/chrony service status, confirmation of documented evidence of continuous time synchronization, and validation of authoritative time source availability monitoring. REMEDIATION STEPS (Technical): Configure NTP poll intervals in /etc/ntp.conf with server time.nist.gov iburst minpoll 6 maxpoll 10 (minpoll 6 = 64 sec minimum, maxpoll 10 = 1024 sec = 17 min maximum); Configure chrony poll intervals in /etc/chrony/chrony.conf with server tick.usno.navy.mil iburst minpoll 4 maxpoll 8 (minpoll 4 = 16 sec, maxpoll 8 = 256 sec = 4.3 min); Configure systemd-timesyncd in /etc/systemd/timesyncd.conf with PollIntervalMinSec=32 and PollIntervalMaxSec=2048; Create automated time drift monitoring cron job */15 * * * * /usr/local/bin/check_time_sync.sh (script contents: timedatectl status | grep -q "synchronized: yes" || send_alert); Implement SIEM integration for time sync monitoring by configuring rsyslog to forward systemd-timesyncd events to central SIEM; Document synchronization frequency in organizational policy specifying DoD-required comparison intervals, time drift tolerances, and monitoring procedures; Test time synchronization failure alerting with sudo systemctl stop systemd-timesyncd &amp;&amp; verify_alert_received; Verify authoritative time source availability with ping time.nist.gov &amp;&amp; traceroute tick.usno.navy.mil to ensure reachability; Document clock comparison frequency requirements in system security configuration baseline.'''
    }
}

def create_backup(filepath):
    """Create timestamped backup."""
    timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
    backup_path = f"{filepath}.backup_{timestamp}"
    shutil.copy2(filepath, backup_path)
    print(f"[OK] Created backup: {os.path.basename(backup_path)}")
    return backup_path


def build_two_index_entry(vuln_id, nf_comment, open_comment):
    """Build XML structure with two Answer Indices."""
    entry = f'''  <Vuln ID="{vuln_id}">
    <AnswerKey Name="XO">
      <Answer Index="1" ExpectedStatus="NotAFinding" Hostname="" Instance="" Database="" Site="" ResultHash="">
        <ValidationCode></ValidationCode>
        <ValidTrueStatus>NotAFinding</ValidTrueStatus>
        <ValidTrueComment>{nf_comment}</ValidTrueComment>
        <ValidFalseStatus></ValidFalseStatus>
        <ValidFalseComment></ValidFalseComment>
      </Answer>
      <Answer Index="2" ExpectedStatus="Open" Hostname="" Instance="" Database="" Site="" ResultHash="">
        <ValidationCode></ValidationCode>
        <ValidTrueStatus>Open</ValidTrueStatus>
        <ValidTrueComment>{open_comment}</ValidTrueComment>
        <ValidFalseStatus></ValidFalseStatus>
        <ValidFalseComment></ValidFalseComment>
      </Answer>
    </AnswerKey>
  </Vuln>'''
    return entry


def integrate_comments(content):
    """Replace empty answer file entries with comprehensive comment content."""
    replacements = 0

    for vuln_id, comments in COMMENTS.items():
        # Find and replace the entire Vuln block
        pattern = rf'<Vuln ID="{vuln_id}">.*?</Vuln>'

        match = re.search(pattern, content, re.DOTALL)
        if not match:
            print(f"  [WARNING] {vuln_id} not found in answer file")
            continue

        old_entry = match.group(0)
        new_entry = build_two_index_entry(vuln_id, comments['NotAFinding'], comments['Open'])

        content = content.replace(old_entry, new_entry)
        replacements += 1
        print(f"  [OK] {vuln_id}: Integrated 2 indices with comprehensive comments")

    return content, replacements


def main():
    print("=" * 80)
    print("Integrate Answer File Comment Content")
    print("=" * 80)
    print()

    # Read answer file
    print(f"Reading answer file: {os.path.basename(ANSWER_FILE_PATH)}")
    with open(ANSWER_FILE_PATH, 'r', encoding='utf-8') as f:
        content = f.read()

    # Create backup
    backup_path = create_backup(ANSWER_FILE_PATH)
    print()

    # Integrate comments
    print("Integrating comprehensive comment content...")
    fixed_content, replacements = integrate_comments(content)

    print()
    print(f"Total entries updated: {replacements}/{len(COMMENTS)}")
    print()

    # Write fixed content
    with open(ANSWER_FILE_PATH, 'w', encoding='utf-8') as f:
        f.write(fixed_content)

    print("=" * 80)
    print("[OK] Answer file comments integrated!")
    print("=" * 80)
    print()
    print("Next steps:")
    print("  1. Validate XML structure")
    print("  2. Run Test118 to verify COMMENTS populate correctly")
    print("  3. Create comments for 5 stub functions")

    return 0


if __name__ == '__main__':
    exit(main())
